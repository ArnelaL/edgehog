#
# This file is part of Edgehog.
#
# Copyright 2021-2024 SECO Mind Srl
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
#

services:
  registry:
    image: registry:2
    restart: on-failure
    environment:
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: Registry-Realm
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/registry.passwd
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /data
    volumes:
      - registry-auth:/auth
      - registry-data:/var/lib/registry
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.edgehog-registry.rule=Host(`registry.${DOCKER_COMPOSE_EDGEHOG_BASE_DOMAIN}`)"
    - "traefik.http.routers.edgehog-registry.entrypoints=web"
    - "traefik.http.routers.edgehog-registry.service=edgehog-registry"
    - "traefik.http.services.edgehog-registry.loadbalancer.server.port=5000"
  registry-auth:
    image: httpd:2.4
    depends_on:
      - registry
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "htpasswd -Bbn admin admin > /auth/registry.passwd"
    volumes:
      - registry-auth:/auth
  registry-init:
    image: docker:25.0.3-dind
    depends_on:
      - registry
    privileged: true
    entrypoint: ["/bin/sh", "-c"]
    command: ["
      dockerd --insecure-registry registry:5000 &
      echo 'Waiting for Docker daemon to be ready...' &&
      until docker info >/dev/null 2>&1; do sleep 1; done &&
      echo 'Docker daemon ready, signing in with registry...' &&
      echo 'admin' | docker login registry:5000 -u admin --password-stdin &&
      echo 'Signed in with registry, pulling sample images...' &&
      docker pull hashicorp/http-echo &&
      echo 'Tagging sample images...' &&
      docker tag hashicorp/http-echo registry:5000/test/http-echo &&
      echo 'Pushing sample images...' &&
      docker push registry:5000/test/http-echo &&
      echo 'Images preloaded.'"]

volumes:
  registry-auth:
  registry-data:
